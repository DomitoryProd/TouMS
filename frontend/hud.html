<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TuD</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <script>
        //At first I thought to actualy have a frontend router, but its all gonna be on backend

        // Object for test purposes
        const gameState = {
            provider: {
            name: "Counter-Strike: Global Offensive",
            appid: 730,
            version: 13923,
            steamid: "76561198000000000",
            timestamp: 1719761234
            },
            map: {
            mode: "competitive",
            name: "de_inferno",
            phase: "live",
            round: 8,
            team_ct: {
                score: 4,
                consecutive_round_losses: 0,
                timeouts_remaining: 1,
                matches_won_this_series: 0
            },
            team_t: {
                score: 3,
                consecutive_round_losses: 1,
                timeouts_remaining: 1,
                matches_won_this_series: 0
            },
            round_wins: {
                ct: [],
                t: []
            }
            },
            round: {
            phase: "live",
            bomb: "planted",
            win_team: ""
            },
            phase_countdowns: {
            phase: "bomb",
            phase_ends_in: "32.1"
            },
            player: {
            steamid: "76561198000000000",
            name: "Player1",
            team: "CT",
            observer_slot: 1,
            activity: "playing",
            state: {
                health: 76,
                armor: 100,
                helmet: true,
                flashed: 0,
                smoked: 0,
                burning: 0,
                money: 250,
                round_kills: 1,
                round_killhs: 1,
                equip_value: 4300
            },
            weapons: {
                weapon_0: {
                name: "weapon_ak47",
                paintkit: "default",
                type: "rifle",
                state: "holstered",
                ammo_clip: 30,
                ammo_clip_max: 30,
                ammo_reserve: 90
                },
                weapon_1: {
                name: "weapon_glock",
                type: "pistol",
                state: "active",
                ammo_clip: 20,
                ammo_clip_max: 20,
                ammo_reserve: 120
                },
                weapon_2: {
                name: "weapon_flashbang",
                type: "Grenade",
                state: "holstered",
                ammo_reserve: 1
                }
            },
            match_stats: {
                kills: 12,
                assists: 3,
                deaths: 4,
                mvps: 2,
                score: 34
            }
            },
            allplayers: {
            "76561198000000000": {
                name: "Player1",
                observer_slot: 1,
                team: "CT",
                state: {
                health: 76,
                armor: 100,
                helmet: true,
                flashed: 0,
                smoked: 0,
                burning: 0,
                money: 250,
                round_kills: 1,
                round_killhs: 1,
                equip_value: 4300
                },
                match_stats: {
                kills: 12,
                assists: 3,
                deaths: 4,
                mvps: 2,
                score: 34
                },
                weapons: {
                weapon_0: {
                    name: "weapon_ak47",
                    paintkit: "default",
                    type: "rifle",
                    state: "holstered",
                    ammo_clip: 30,
                    ammo_clip_max: 30,
                    ammo_reserve: 90
                },
                weapon_1: {
                    name: "weapon_glock",
                    type: "pistol",
                    state: "active",
                    ammo_clip: 20,
                    ammo_clip_max: 20,
                    ammo_reserve: 120
                }
                },
                position: "102.1,300.4,18.0",
                forward: "1,0,0"
            },
            "76561198000000001": {
                name: "Player2",
                observer_slot: 2,
                team: "CT",
                state: {
                health: 100,
                armor: 100,
                helmet: true,
                money: 800,
                round_kills: 0,
                round_killhs: 0,
                equip_value: 3700
                },
                match_stats: {
                kills: 5,
                assists: 2,
                deaths: 6,
                mvps: 1,
                score: 20
                },
                weapons: {
                weapon_0: {
                    name: "weapon_m4a1",
                    type: "rifle",
                    state: "active",
                    ammo_clip: 25,
                    ammo_clip_max: 25,
                    ammo_reserve: 75
                }
                },
                position: "150.0,275.0,18.0",
                forward: "0,1,0"
            },
            "76561198000000002": {
                name: "Player3",
                observer_slot: 3,
                team: "T",
                state: {
                health: 100,
                armor: 50,
                helmet: false,
                money: 150,
                round_kills: 0,
                round_killhs: 0,
                equip_value: 2900
                },
                match_stats: {
                kills: 7,
                assists: 1,
                deaths: 5,
                mvps: 0,
                score: 17
                },
                weapons: {
                weapon_0: {
                    name: "weapon_mac10",
                    type: "smg",
                    state: "active",
                    ammo_clip: 30,
                    ammo_clip_max: 30,
                    ammo_reserve: 100
                }
                },
                position: "400.0,150.0,18.0",
                forward: "-1,0,0"
            },
            "76561198000000003": {
                name: "Player4",
                observer_slot: 4,
                team: "T",
                state: {
                health: 55,
                armor: 0,
                helmet: false,
                money: 300,
                round_kills: 1,
                round_killhs: 0,
                equip_value: 2500
                },
                match_stats: {
                kills: 10,
                assists: 4,
                deaths: 7,
                mvps: 1,
                score: 28
                },
                weapons: {
                weapon_0: {
                    name: "weapon_tec9",
                    type: "pistol",
                    state: "active",
                    ammo_clip: 18,
                    ammo_clip_max: 18,
                    ammo_reserve: 90
                }
                },
                position: "450.0,180.0,18.0",
                forward: "-1,0,0"
            },
            "76561198000000004": {
                name: "Player5",
                observer_slot: 5,
                team: "T",
                state: {
                health: 0,
                armor: 0,
                helmet: false,
                money: 0,
                round_kills: 0,
                round_killhs: 0,
                equip_value: 0
                },
                match_stats: {
                kills: 2,
                assists: 0,
                deaths: 9,
                mvps: 0,
                score: 6
                },
                weapons: {},
                position: "0,0,0",
                forward: "0,0,0"
            }
            },
            grenades: [],
            bomb: {
            state: "planted",
            position: "300.1,240.5,18.0",
            player: "76561198000000003",
            countdown: "32.1"
            }
        };
        
        // All pages in here
        let pages = {
            hud: function() {
                let html = `
                    <div class="wrapper">
                        <div class="scores">
                            <div id="ct">
                                <h1></h1>
                            </div>
                            <span id="scorect">0</span>
                            <span id="scoret">0</span>
                            <div id="t">
                                <h1></h1>
                            </div>
                        </div>
                        <div class="playerstats">
                            <div id="centerplank" class="centerplank">
                                <div class="row name" id="name"></div>
                                <div class="row st">
                                    <div class="kda">
                                        <div class="stat icon-kills">
                                            <p>K</p>
                                            <span id="kills"></span>
                                        </div>
                                        <div class="stat icon-deaths">
                                            <p>D</p>
                                            <span id="deaths"></span>
                                        </div>
                                        <div class="stat icon-assists">
                                            <p>A</p>
                                            <span id="assists"></span>
                                        </div>
                                    </div>
                                    <div class="stats">
                                        <div class="stat icon-money">
                                            üí≤
                                            <span id="money"></span>
                                        </div>
                                        <div class="stat icon-armor">
                                            üõ°Ô∏è
                                            <span id="armor"></span>
                                        </div>
                                        <div class="stat icon-health">
                                            ‚ù§Ô∏è
                                            <span id="health"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.querySelector("body").innerHTML = html;
            }
        };
        pages.hud();

        // Connect to WebSocket on the same port as the Express server
        // Use window.location.hostname to work from any device on the network
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.hostname}:3000`;
        const ws = new WebSocket(wsUrl);

        ws.addEventListener("open", () => {
            console.log("connection is established");
        });
        
        
        ws.addEventListener("message", (e) => {
            console.log(e.data);
            let data = JSON.parse(e.data);
            console.log(data.player.name);

            source = data;
            if (data.player.team == "CT") {
                document.getElementById("centerplank").classList.remove("ct");
                document.getElementById("centerplank").classList.remove("t");
                document.getElementById("centerplank").classList.add("ct");
            } else {
                document.getElementById("centerplank").classList.remove("ct");
                document.getElementById("centerplank").classList.remove("t");
                document.getElementById("centerplank").classList.add("t");
            }
            
            document.getElementById("scorect").innerHTML = source.map.team_ct.score || 0;
            document.getElementById("scoret").innerHTML = source.map.team_t.score || 0;

            document.getElementById("name").innerHTML = source.player.name;
            document.getElementById("kills").innerHTML = source.player.match_stats.kills;
            document.getElementById("assists").innerHTML = source.player.match_stats.assists;
            document.getElementById("deaths").innerHTML = source.player.match_stats.deaths;
            document.getElementById("health").innerHTML = source.player.state.health;
            document.getElementById("armor").innerHTML = source.player.state.armor;
            document.getElementById("money").innerHTML = source.player.state.money;
            // Display the full data object in readable format
            let formattedData = formatObject(data);
            
            // Also update scores if they exist in the data
            if (data.map && data.map.team_ct && data.map.team_t) {
                document.getElementById("scorect").innerHTML = game.map.team_ct.score || 0;
                document.getElementById("scoret").innerHTML = data.map.team_t.score || 0;
            }
        });
        
        // Function to format object into readable HTML
        function formatObject(obj, indent = 0) {
            let html = '';
            const indentStr = '&nbsp;'.repeat(indent * 4);
            
            for (let key in obj) {
                if (obj.hasOwnProperty(key)) {
                    const value = obj[key];
                    const valueType = typeof value;
                    
                    html += `<div style="margin-left: ${indent * 20}px; margin-bottom: 5px;">`;
                    
                    if (valueType === 'object' && value !== null) {
                        html += `<strong style="color: #007acc;">${key}:</strong>`;
                        html += formatObject(value, indent + 1);
                    } else {
                        let displayValue = value;
                        if (valueType === 'string') {
                            displayValue = `"${value}"`;
                        } else if (valueType === 'boolean') {
                            displayValue = value ? 'true' : 'false';
                        }
                        
                        html += `<strong style="color: #007acc;">${key}:</strong> <span style="color: #d63384;">${displayValue}</span>`;
                    }
                    
                    html += '</div>';
                }
            }
            
            return html;
        }
    </script>
</body>
</html>